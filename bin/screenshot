#!/bin/bash
# A bemenu script for taking screenshots for wayland
# DEPS: xdg-utils, wl-clipboard, slurp, grim, bemenu
# Usage: screenshot [command]
# Commands:
#   select (default)
#   full
SCREENSHOT_DIR=~/Pictures/Screenshots
MENU_CMD="bemenu"
TEMP_FILE="/tmp/screenshot.png"

save ()
{
  name=$1
  if [[ "$name" != *.png ]] ; then
   name="$name.png"
  fi

  mkdir -p "$SCREENSHOT_DIR"
  path="$SCREENSHOT_DIR/$name"
  if [ -f $path ] ; then
    action=$(echo $'overwrite\nexit' | $MENU_CMD --prompt exists)
    if [ "$action" = "overwrite" ] ; then 
      cp $TEMP_FILE "$path"
    elif [[ "$action" = "exit" ]]; then
      rm -f $TEMP_FILE
      exit 0
    elif [ -n "$action" ] ; then
      save $action
    fi
  else
    cp $TEMP_FILE "$path"
  fi
}

command=$1
if [ -z "$command" ] ; then
  command="select"
fi
if [ -z "$command" ] ; then
  exit -1
fi

if [ "$command" = "full" ] ; then
  grim $TEMP_FILE
fi
if [ "$command" = "select" ] ; then
  slurp | grim -g - $TEMP_FILE
fi

action=$(echo $'retake\nclipboard' | $MENU_CMD --prompt save ) 

if [ "$action" = "retake" ] ; then
  screenshot
  exit 0
elif [ "$action" = "clipboard" ] ; then
  cat $TEMP_FILE | wl-copy
elif [ -n "$action" ] ; then
  save $action
fi
   

rm -f $TEMP_FILE
